@startuml SimpleLicense.LicenseValidation

!define POSITIVE_COLOR #90EE90
!define NEUTRAL_COLOR #E0E0E0
!define VALIDATION_COLOR #87CEEB

title SimpleLicense.LicenseValidation - Architecture Overview

package "SimpleLicense.LicenseValidation" {

    ' ============================================================================
    ' Core License Document
    ' ============================================================================
    
    class LicenseDocument {
        - _fields: Dictionary<string, object?>
        + LicenseDocument(ensureMandatoryKeys: bool)
        + this[name: string]: object?
        + Fields: IEnumerable<KeyValuePair<string, object?>>
        --
        + SetField(name: string, value: object?, out error: string?): bool
        + EnsureMandatoryPresent(): void
        + ToJson(validate: bool): string
        + FromJson(json: string): LicenseDocument
        + {static} RegisterValidator(fieldName: string, validator: FieldValidator): void
        --
        <<Field-Level Validation>>
        Validates individual field values
    }

    ' ============================================================================
    ' Schema Classes
    ' ============================================================================
    
    class LicenseSchema {
        + Name: string
        + Fields: List<FieldDescriptor>
        --
        + LicenseSchema()
        + LicenseSchema(name: string, fields: List<FieldDescriptor>)
        --
        + {static} FromFile(path: string): LicenseSchema
        + {static} ToFile(schema: LicenseSchema, path: string): void
        + {static} FromJson(json: string): LicenseSchema
        + {static} ToJson(schema: LicenseSchema): string
        + {static} FromYaml(yaml: string): LicenseSchema
        + {static} ToYaml(schema: LicenseSchema): string
        --
        + Validate(): void
        + TryValidate(out errors: IReadOnlyList<string>): bool
        - ValidateCore(): List<string>
        --
        <<Schema Definition>>
        Defines structure of licenses
    }

    class FieldDescriptor {
        + Name: string
        + Type: string
        + Signed: bool = true
        + Required: bool = false
        + DefaultValue: object? = null
        --
        + FieldDescriptor()
        + FieldDescriptor(Name, Type, Signed, Required, DefaultValue)
        --
        <<Field Specification>>
        Describes a single license field
    }

    ' ============================================================================
    ' Validators
    ' ============================================================================
    
    class LicenseValidator {
        - _schema: LicenseSchema
        --
        + LicenseValidator(schema: LicenseSchema)
        --
        + Validate(license: LicenseDocument, out errors: List<string>): bool
        + ValidateOrThrow(license: LicenseDocument): void
        + GetSchemaSummary(): string
        - ValidateFieldType(fieldName, fieldValue, expectedType, errors): void
        --
        <<Schema-Level Validation>>
        Validates license structure
        against schema definition
    }

    class FieldValidators <<static>> {
        - {static} _validators: Dictionary<string, FieldValidator>
        - {static} _initialized: bool
        - {static} _lock: object
        --
        + {static} All: IReadOnlyDictionary<string, FieldValidator>
        --
        + {static} Register(fieldName: string, validator: FieldValidator): void
        + {static} TryGetValidator(fieldName: string, out validator: FieldValidator?): bool
        + {static} GetValidator(fieldName: string): FieldValidator?
        - {static} EnsureInitialized(): void
        - {static} RegisterDefaultValidators(): void
        - {static} AutoDiscoverValidators(): void
        --
        + {static} ValidateLicenseId(value: object?): ValidationResult
        + {static} ValidateExpiryUtc(value: object?): ValidationResult
        + {static} ValidateSignature(value: object?): ValidationResult
        + {static} ValidateMaxUsers(value: object?): ValidationResult
        + {static} ValidateCustomerName(value: object?): ValidationResult
        --
        <<Field-Level Validator Registry>>
        Auto-discovery with attributes
    }

    ' ============================================================================
    ' Supporting Types
    ' ============================================================================
    
    class ValidationResult <<struct>> {
        + IsValid: bool
        + OutputValue: object?
        + Error: string?
        --
        + ValidationResult(isValid, outputValue, error)
        + {static} Success(outputValue: object?): ValidationResult
        + {static} Fail(error: string): ValidationResult
        --
        <<Validation Outcome>>
    }

    class LicenseValidationException {
        + Issues: IReadOnlyList<string>
        --
        + LicenseValidationException(issues: IEnumerable<string>)
        - {static} CreateMessage(issues): string
        --
        <<Validation Errors>>
    }

    class FieldValidatorAttribute {
        + FieldName: string
        --
        + FieldValidatorAttribute(fieldName: string)
        --
        <<Auto-Discovery>>
    }

    ' ============================================================================
    ' Delegate
    ' ============================================================================
    
    interface FieldValidator <<delegate>> {
        + Invoke(value: object?): ValidationResult
    }

    ' ============================================================================
    ' Relationships
    ' ============================================================================
    
    ' Composition
    LicenseSchema *-- "many" FieldDescriptor : contains
    LicenseValidator o-- LicenseSchema : uses
    
    ' Dependencies
    LicenseDocument ..> FieldValidators : uses for\nfield validation
    LicenseDocument ..> ValidationResult : returns
    LicenseDocument ..> LicenseValidationException : throws
    
    LicenseValidator ..> LicenseDocument : validates
    LicenseValidator ..> LicenseValidationException : throws
    
    FieldValidators ..> ValidationResult : returns
    FieldValidators ..> FieldValidator : stores
    FieldValidators ..> FieldValidatorAttribute : discovers by
    
    FieldValidator ..> ValidationResult : returns
    
    ' Associations
    LicenseDocument -- LicenseValidator : validated by >

}

' ============================================================================
' Architecture Notes
' ============================================================================

note right of LicenseDocument
  **Field-Level Validation**
  ───────────────────────
  • Validates individual field VALUES
  • Uses FieldValidators registry
  • Applied when setting fields
  • Handles type conversion
  • Normalizes values
end note

note right of LicenseValidator
  **Schema-Level Validation**
  ───────────────────────
  • Validates license STRUCTURE
  • Ensures required fields present
  • Verifies field types match schema
  • Checks overall conformance
end note

note right of FieldValidators
  **Validator Registry**
  ───────────────────────
  • Thread-safe singleton
  • Auto-discovers validators
  • Uses [FieldValidator] attribute
  • Supports custom validators
  • Case-insensitive lookup
end note

note bottom of LicenseSchema
  **Schema Storage**
  ───────────────────────
  • JSON & YAML support
  • File I/O with auto-detection
  • Self-validation
  • Supports default values
end note

' ============================================================================
' Legend
' ============================================================================

legend right
  **Two-Tier Validation Architecture**
  ═══════════════════════════════
  
  **Tier 1: Field-Level** (FieldValidators)
  → Validates individual field values
  → Ensures correct format and type
  → Normalizes and converts data
  
  **Tier 2: Schema-Level** (LicenseValidator)
  → Validates overall structure
  → Checks required fields
  → Verifies schema compliance
  
  ───────────────────────────────
  
  **Key Patterns:**
  • Registry Pattern (FieldValidators)
  • Auto-Discovery (via attributes)
  • Delegate-based extensibility
  • Immutable records (Schema/FieldDescriptor)
end legend

@enduml
